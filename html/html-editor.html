<!-- https://jay23606.github.io/chat-gpt-voice/html/html-editor.html -->

<div id="my-contenteditable" contenteditable="true" spellcheck="false"></div>
<button onclick="saveAndRestore()">Save and Restore Cursor</button>

<script>
function debounce(func, wait, immediate) {
  let timeout;
  return function() {
    const context = this, args = arguments;
    const later = function() {
      timeout = null;
      if (!immediate) func.apply(context, args);
    };
    const callNow = immediate && !timeout;
    clearTimeout(timeout);
    timeout = setTimeout(later, wait);
    if (callNow) func.apply(context, args);
  };
}

function saveAndRestore() {
  const contentEditable = document.getElementById('my-contenteditable');
  const selection = window.getSelection();
  const baseOffset = selection.baseOffset;
  const placeholder = document.createElement('span');
  placeholder.id = 'cursor-pos';
  placeholder.style.display = 'none';
  const range = selection.getRangeAt(0);
  range.insertNode(placeholder);
  range.setStartBefore(placeholder);
  range.collapse(true);
  selection.removeAllRanges();
  selection.addRange(range);

  // Calculate the line number of the cursor
  const textBeforeCursor = contentEditable.innerText.slice(0, baseOffset);
  const lineNumber = (textBeforeCursor.match(/\n/g) || []).length + 1;

  // Save the line number to the placeholder element
  placeholder.dataset.lineNumber = lineNumber;
}

function highlightXMLTags() {
  const contentEditable = document.getElementById('my-contenteditable');

  // Highlight XML/HTML tags in orange
  const xmlRegex = /&lt;(\/?[^<&]*?)&gt;(?!([^<]*>|[^&]*;))/g;
  contentEditable.innerHTML = contentEditable.innerHTML.replace(xmlRegex, '<span style="color: orange;">&lt;$1&gt;</span>');

  // Restore the cursor position
  requestAnimationFrame(() => {
    const cursorPos = document.getElementById('cursor-pos');
    if (cursorPos) {
      const range = document.createRange();
      range.setStartBefore(cursorPos);
      range.setEndBefore(cursorPos);
      const selection = window.getSelection();
      selection.removeAllRanges();
      selection.addRange(range);

      // Scroll to the correct line number
      const lineNumber = cursorPos.dataset.lineNumber;
      if (lineNumber) {
        contentEditable.scrollTop = (lineNumber - 1) * 20;
      }

      cursorPos.parentNode.removeChild(cursorPos);
    }
  });
}

const saveAndRestoreDebounced = debounce(saveAndRestore, 250);
const highlightXMLTagsDebounced = debounce(highlightXMLTags, 250);

document.getElementById('my-contenteditable').addEventListener('keyup', () => {
  saveAndRestoreDebounced();
  highlightXMLTagsDebounced();
});
</script>
