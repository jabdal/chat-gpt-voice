<!DOCTYPE html>
<html lang="en">
<head>
    <title>Chat GPT Voice</title>
    <meta charset="utf-8" />
    <!--<link rel="manifest" href="manifest.json" />-->
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
        body, html {
            margin: 0;
            height: 100%;
            font-size: large;
            background: black;
            color: white
        }
    </style>
    <link rel="icon" href="data:,">
</head>
<body>
    <textarea id="prompt-input" style="width:100vw;height:4em;font-size:large" placeholder="Enter prompt or touch screen for voice prompt"></textarea>
    <div style="text-align:right">
        <input type="checkbox" id="code-cbx" style="width:2em;height:2em"><label for="code-cbx">Code</label>
        <input checked type="checkbox" id="enable-voice" style="width:2em;height:2em"><label for="enable-voice">Voice</label>
        <button id="submit-button" style="width:50vw;text-align:center;height:2.5em;font-size:large">Submit</button>
    </div>
    <button id="save-code" style="display:none">Save</button>
    <div id="openai-output" style="white-space:pre-wrap; color: white"></div>
    <div id="code-output"></div>

    <script>
        const body = document.body;
        const $ = id => document.getElementById(id);
        const cancelSpeaking = () => { let wasSpeaking = speechSynthesis.speaking; timer.disableSpeaking(); stopStreaming = true; speechSynthesis.cancel(); return wasSpeaking; }
        body.addEventListener('beforeunload', () => this.cancelSpeaking());
        let enableVoice = $('enable-voice'), codeCbx = $('code-cbx'), submitBtn = $('submit-button'), promptInput = $('prompt-input'), openaiOutput = $('openai-output'),
            codeOutput = $('code-output'), saveCode = $('save-code'), stopStreaming = false, history = [], sentences = [], sIndex = 0;
        promptInput.focus(); enableVoice.disabled = false;
        enableVoice.addEventListener('change', e => localStorage.setItem('ENABLE_VOICE', e.target.checked));
        enableVoice.checked = (localStorage.getItem('ENABLE_VOICE') ?? "true") === "true";

        submitBtn.addEventListener('click', async () => {
            codeOutput.textContent = '';
            const words = promptInput.value.split(' ');
            if (words.length < 3) body.style.background = words.join(''); //easter egg for my son
            cancelSpeaking();
            var token = localStorage.getItem('OPENAI_API_KEY');
            if (!token || token.length < 10) {
                token = prompt("Please input OpenAI API key (stored in browser cache)", "");
                localStorage.setItem('OPENAI_API_KEY', token)
            }
            await openAiSend(promptInput, openaiOutput, token);
            history.push({ role: 'user', content: promptInput.value }, { role: 'assistant', content: openaiOutput.textContent });
            if (history.length > 4) { history.shift(); history.shift(); }
            outputHtml(codeOutput);
        });

        saveCode.addEventListener('click', () => outputHtml(codeOutput));
        const outputHtml = (div) => {
            if (codeCbx.checked) {
                openaiOutput.contentEditable = "true"; saveCode.style.display = 'block';
                div.style.background = 'white'; div.style.color = 'black';
                div.innerHTML = '';
                let r = openaiOutput.textContent
                let t0 = r.indexOf("```html"); let t0_ = r.indexOf("```");
                if (t0 > 0) t0 += 7; if (t0 < 0 && t0_ > 0) { t0 = t0_; t0 += 3; }
                if (t0 > 0) { 
                    let t1 = r.indexOf("```", t0);
                    if (t1 > t0) r = r.substring(t0, t1);
                }
                var iframe = document.createElement('iframe');
                iframe.width = '100%'; iframe.height = `${innerHeight >> 1}`;
                iframe.srcdoc = r;
                div.appendChild(iframe);
            } else { openaiOutput.contentEditable = "false"; saveCode.style.display = 'none'; }
        }

        const recognition = (input, btn, lang = 'en-US') => {
            var SpeechRecognition = SpeechRecognition || webkitSpeechRecognition;
            let recognition = new SpeechRecognition();
            recognition.lang = lang;
            body.onclick = e => ((e.target === body || e.target.id === 'openai-output') && enableVoice.checked) ? ((cancelSpeaking()) ? '' : recognition.start()) : '';
            recognition.onresult = e => { input.value = e.results[0][0].transcript; if (btn) btn.click() }
            recognition.onspeechend = () => recognition.stop();
        }
        recognition(promptInput, submitBtn);

        const timer = {
            iid: 0,
            enableSpeaking: function () {
                this.disableSpeaking();
                this.iid = setInterval(() => {
                    if (!enableVoice.checked) return;
                    if (!speechSynthesis.speaking && sentences.length > 0 && sentences.length > sIndex) {
                        var utter = new SpeechSynthesisUtterance();
                        utter.text = sentences[sIndex].join('');
                        utter.lang = 'en-AU'; utter.rate = 1.4;
                        speechSynthesis.speak(utter);
                        sIndex++;
                    }
                }, 500);
            },
            disableSpeaking: function () { if (this.iid) clearInterval(this.iid) }
        };

        const openAiSend = async (input, output, token) => {
            let system = [];
            if (codeCbx.checked) system.push({ "role": "system", "content": "Write HTML and JS only.No comments or explanation.Put script tag in the body." });
            const response = await fetch('https://api.openai.com/v1/chat/completions', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                body: JSON.stringify({ model: "gpt-3.5-turbo", temperature: 0.8, stream: true, messages: [...system, ...history, { role: "user", content: input.value }] })
            });
            let arr = [], arr2 = [];
            sentences = []; sIndex = 0;
            const reader = response.body.getReader();
            reader.onerror = err => cancelSpeaking();
            stopStreaming = false;
            timer.enableSpeaking();
            for (; ;) {
                const { done, value } = await reader.read();
                if (done) return;
                const textDecoder = new TextDecoder();
                const chunk = textDecoder.decode(value, { stream: true });
                const lines = chunk.split('\n');
                for (const line of lines) {
                    if (stopStreaming) return;
                    if (line.length === 0 || line.startsWith(':')) continue;
                    if (line === 'data: [DONE]') {
                        if (!enableVoice.checked) return;
                        if (arr.length) sentences.push(arr);
                        return;
                    }
                    const json = JSON.parse(line.substring(6));
                    if (!json.choices) continue;
                    const word = json.choices[0].delta.content || '';
                    arr.push(word); arr2.push(word);
                    if (/[.;!?]$/.test(word.trimEnd())) { sentences.push(arr); arr = []; }
                    output.textContent = arr2.join('');
                }
            }
        }
    </script>
</body>
</html>
