<!DOCTYPE html>
<html lang="en-us">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width">
    <title>Minimal example of recording audio and sending the recording to whisper-1 endpoint</title>
</head>
<body>
    <button class="record">Record</button>
    <button class="stop">Stop</button>
    <div id="output"></div>
    <script>
        const record = document.querySelector('.record');
        const stop = document.querySelector('.stop');
        const soundClips = document.querySelector('.sound-clips');
        stop.disabled = true;
        let audioCtx;
        if (navigator.mediaDevices.getUserMedia) {
            const constraints = { audio: true };
            let chunks = [];
            let onSuccess = function (stream) {
                const mediaRecorder = new MediaRecorder(stream);
                record.onclick = function () {
                    mediaRecorder.start();
                    stop.disabled = false;
                    record.disabled = true;
                }
                stop.onclick = function () {
                    mediaRecorder.stop();
                    stop.disabled = true;
                    record.disabled = false;
                }
                mediaRecorder.onstop = function (e) {
                    const blob = new Blob(chunks, { 'type': 'audio/webm' });
                    chunks = [];
                    var token = localStorage.getItem('OPENAI_API_KEY');
                    if (!token || token.length < 10) {
                        token = prompt("Please input OpenAI API key (stored in browser cache)", "");
                        localStorage.setItem('OPENAI_API_KEY', token)
                    }
                    const formData = new FormData();
                    formData.append('file', blob, "test.webm");
                    formData.append('model', 'whisper-1');
                    const requestOptions = {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${token}`
                        },
                        body: formData
                    };
                    fetch('https://api.openai.com/v1/audio/transcriptions', requestOptions)
                        .then(response => response.json())
                        .then(data => {
                            console.log(data);
                            document.getElementById('output').textContent = data.text;
                        })
                        .catch(error => console.log('Error:', error));
                }
                mediaRecorder.ondataavailable = function (e) { chunks.push(e.data) }
            }
            let onError = function (err) { console.log('The following error occured: ' + err) }
            navigator.mediaDevices.getUserMedia(constraints).then(onSuccess, onError);
        }
    </script>
</body>
</html>
