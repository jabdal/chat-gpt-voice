<!DOCTYPE html>
<html lang="en-us">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width">
    <title>Minimal example of recording audio and sending the recording to whisper-1 endpoint</title>
</head>
<body>
    <button id="record">Record</button>
    <div id="output"></div>
    <script>
        (() => {
            const $ = id => document.getElementById(id), record = $('record'), devices = navigator.mediaDevices, constraints = { audio: true };
            if (!devices.getUserMedia) return;
            let chunks = [];
            let onSuccess = (stream) => {
                const recorder = new MediaRecorder(stream);
                record.onclick = () => record.textContent === 'Stop' ? (recorder.stop(), record.textContent = 'Start') : (recorder.start(), record.textContent = 'Stop');
                recorder.onstop = e => {
                    if (!(token = localStorage.getItem('OPENAI_API_KEY'))) 
                        localStorage.setItem('OPENAI_API_KEY', token = prompt("Please input OpenAI API key (stored in browser cache)", ""))
                    const data = new FormData();
                    data.append('file', new Blob(chunks, { 'type': 'audio/webm' }), "test.webm")
                    data.append('model', 'whisper-1');
                    const opts = { method: 'POST', headers: { 'Authorization': `Bearer ${token}` }, body: data };
                    chunks = [];
                    fetch('https://api.openai.com/v1/audio/transcriptions', opts)
                        .then(response => response.json())
                        .then(data => $('output').textContent = data.text)
                        .catch(error => console.log('Error:', error));
                }
                recorder.ondataavailable = e => chunks.push(e.data)
            }
            let onError = err => console.log('The following error occured: ' + err)
            devices.getUserMedia(constraints).then(onSuccess, onError);
        })();
    </script>
</body>
</html>
